# Million Items — Fullstack тестовое задание

## Стек
- **Backend**: Express.js (Node.js)
- **Frontend**: React 18 + @dnd-kit
- **Хранение**: In-memory (без БД)
- **Деплой**: Railway

## Архитектура

```
project/
├── server/
│   ├── index.js          # Express сервер
│   ├── state.js          # In-memory хранилище (1M элементов)
│   ├── queue.js          # Очередь с дедупликацией и батчингом
│   └── routes/
│       ├── items.js      # GET/POST /api/items
│       └── selected.js   # GET/POST/DELETE/PUT /api/selected
├── client/
│   └── src/
│       ├── api/queue.js              # Клиентская очередь запросов
│       ├── hooks/
│       │   ├── useInfiniteScroll.js  # IntersectionObserver
│       │   └── useDebounce.js        # Задержка поиска
│       └── components/
│           ├── LeftPanel/            # Все элементы
│           └── RightPanel/           # Выбранные + DnD
├── railway.json          # Railway конфиг
└── package.json          # Monorepo скрипты
```

## Ключевые решения

### Производительность с 1M элементов
- Сервер хранит ID в `Set` (O(1) для has/add/delete)
- Пагинация: клиент получает только 20 элементов за раз
- Итерация по Set прерывается через `break` после заполнения страницы

### Очередь с дедупликацией
- **ADD_ITEM**: батч раз в 10 секунд, дедупликация по ID
- **SELECT / DESELECT / REORDER**: батч раз в 1 секунду
- Если SELECT и DESELECT для одного ID одновременно — второй отменяет первый
- Клиентская очередь синхронизирована с серверной: те же интервалы батчинга

### Оптимистичное обновление UI
- При выборе элемента в левой панели он **мгновенно** появляется в правой (без ожидания батча на сервере)
- Оптимистичное удаление: элемент сразу убирается из списка при снятии выбора
- Синхронизация с сервером происходит в фоне через очередь батчей

### Drag & Drop с фильтром
- Перетаскивание работает на отфильтрованном списке
- После DnD пересчитывается полный порядок через `mergeSortedVisible()`
- Невидимые элементы сохраняют свои относительные позиции
- Сервер принимает частичный порядок (только видимые элементы) и корректно достраивает его

### Сохранение состояния фильтра
- Фильтр правой панели сохраняется в `localStorage` и восстанавливается при перезагрузке страницы
- Левая панель: фильтр не сохраняется (как по ТЗ)

### Соответствие ТЗ
- **Два окна**: левая панель — все элементы (кроме выбранных), правая — выбранные.
- **1 000 000 элементов**: инициализация ID `1..1_000_000` в памяти при старте (`state.js`).
- **Фильтр по ID**: в обеих панелях, поиск по подстроке ID. Фильтр правой панели сохраняется в `localStorage` между перезагрузками.
- **Инфинити-скролл**: и слева, и справа загрузка по 20 элементов, дальнейшая подгрузка по скроллу.
- **Добавление новых ID**: в левой панели можно добавить произвольный ID, хранится на сервере.
- **Drag&Drop сортировка**: правая панель на `@dnd-kit`, работает и для отфильтрованного списка. Сервер корректно обрабатывает частичный порядок.
- **Сохранение выбора и порядка**: выбранные элементы и их порядок живут на сервере в памяти между перезагрузками страницы.
- **Без учётных записей**: состояние общее для всех посетителей.
- **Очередь запросов**: на клиенте и сервере реализована очередь с дедупликацией и батчингом (добавление — раз в 10 сек, выбор/снятие/сортировка — раз в 1 сек).
- **Оптимистичное обновление**: элементы появляются/исчезают мгновенно, синхронизация с сервером в фоне.

## Локальный запуск

```bash
# Установить зависимости
npm run install:all

# Запустить сервер (порт 3001)
npm run dev:server

# Запустить клиент (порт 3000) — в другом терминале
npm run dev:client
```

Открыть: http://localhost:3000

## Деплой на Railway

### Вариант 1: через CLI

```bash
npm install -g @railway/cli
railway login
railway init
railway up
```

### Вариант 2: через GitHub

1. Создать репозиторий на GitHub и запушить код
2. Зайти на [railway.app](https://railway.app)
3. "New Project" → "Deploy from GitHub repo"
4. Выбрать репозиторий
5. Railway автоматически прочитает `railway.json`
6. После деплоя: Settings → Generate Domain

## API

| Метод  | URL                    | Описание                              |
|--------|------------------------|---------------------------------------|
| GET    | /api/items             | Список доступных (filter, offset)     |
| POST   | /api/items             | Добавить новый ID `{ id: number }`    |
| GET    | /api/selected          | Список выбранных (filter, offset)     |
| POST   | /api/selected/:id      | Выбрать элемент                       |
| DELETE | /api/selected/:id      | Снять выбор                           |
| PUT    | /api/selected/reorder  | Новый порядок `{ order: number[] }`   |
